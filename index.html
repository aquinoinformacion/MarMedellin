<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Una decisi√≥n de 195 mil millones para cumplir ¬øun capricho?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            transition: all 0.3s ease;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #7010A6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #7010A6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .slider:hover {
            opacity: 0.9;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7010A6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="min-h-screen bg-gradient-to-br from-purple-50 to-yellow-50">
            <div class="max-w-7xl mx-auto px-4 py-8">
                <!-- Header -->
                <header class="text-center mb-10">
                    <!-- Imagen del header -->
                    <div class="mb-8">
                        <img src="HeaderMaryplaya.png" alt="Header Mar y Playa Medell√≠n" 
                             class="w-full max-w-6xl mx-auto rounded-lg shadow-lg">
                    </div>
                    
                    <h1 class="text-3xl md:text-5xl font-bold text-purple-900 mb-6">
                        ¬ø195 mil millones en piscinas mientras Medell√≠n se ahoga en problemas reales?
                    </h1>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <h3 class="text-xl font-bold text-red-900 mb-3">Mientras el Alcalde sue√±a con playas artificiales, Medell√≠n enfrenta:</h3>
                        <div class="grid md:grid-cols-2 gap-3 text-sm">
                            <div>‚Ä¢ <strong>313,257 personas</strong> viviendo en pobreza multidimensional</div>
                            <div>‚Ä¢ <strong>221.000 personas</strong> con inseguridad alimentaria severa</div>
                            <div>‚Ä¢ <strong>128.000 personas</strong> viviendo en hacinamiento</div>
                        </div>
                    </div>
                    
                    <p class="text-lg text-gray-700 mb-6">
                        <strong>¬ø¬øEs el mar una prioridad en Medell√≠n cuando hay otras necesidades sin resolver?</strong> 
                        Esta respuesta parece m√°s un capricho personal que una soluci√≥n a lo que Medell√≠n realmente necesita.
                    </p>
                    
                    <h3 class="text-2xl font-bold text-purple-900 mb-4">Con esos 195 mil millones, en lugar de Mar y Playa, podr√≠amos::</h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 text-center">
                        <div class="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-500">
                            <div class="text-5xl mb-2">üè†</div>
                            <div class="text-3xl font-bold text-gray-800 mb-1">650 casas</div>
                            <div class="text-sm text-gray-600 mb-2">de 300 millones cada una</div>
                            <div class="text-lg font-semibold text-yellow-700">1 de cada 10 familias de Bel√©n</div>
                        </div>
                        
                        <div class="bg-green-50 p-6 rounded-lg border-l-4 border-green-500">
                            <div class="text-5xl mb-2">üè´</div>
                            <div class="text-3xl font-bold text-gray-800 mb-1">5 mega colegios</div>
                            <div class="text-sm text-gray-600 mb-2"> para atender m√°s de 8000 estudiantes</div>
                            <div class="text-lg font-semibold text-green-700"> y asegurar la cobertura con criterios de calidad en las comunas del norte</div>
                        </div>
                        
                        <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-500">
                            <div class="text-5xl mb-2">üõ†Ô∏è</div>
                            <div class="text-3xl font-bold text-gray-800 mb-1">6,845 metros </div>
                            <div class="text-sm text-gray-600 mb-2">obras de estabilizaci√≥n</div>
                            <div class="text-lg font-semibold text-blue-700">para prevenir accidentes mortales</div>
                        </div>
                        
                        <div class="bg-purple-50 p-6 rounded-lg border-l-4 border-purple-500">
                            <div class="text-5xl mb-2">üéì</div>
                            <div class="text-3xl font-bold text-gray-800 mb-1">32,500 semestres</div>
                            <div class="text-sm text-gray-600 mb-2">universitarios</div>
                            <div class="text-lg font-semibold text-purple-700">todos los j√≥venes de Popular y Santa Cruz</div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-purple-900 text-white rounded-lg">
                        <p class="text-lg font-semibold text-center">
                            El "mar" es el capricho de uno. Las necesidades son de todos.
                        </p>
                        <p class="text-xl font-bold text-center text-yellow-300 mt-2">
                            Si t√∫ fueras alcalde que priorizar√≠as para Medell√≠n, ¬øcaprichos o necesidades?
                        </p>
                    </div>
                </header>

                <!-- Distribuidor de presupuesto -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-900 mb-2">Es hora de que Medell√≠n realmente decida</h2>
                        <p class="text-gray-600">Mueve las barras para mostrar cu√°les son las prioridades de Medell√≠n</p>
                        <p class="text-sm text-yellow-600 font-semibold mt-2">üí° Tip: Las barras se mueven en incrementos de $1,000 millones para facilitar la distribuci√≥n exacta</p>
                    </div>
                    
                    <div class="grid lg:grid-cols-3 gap-6">
                        <!-- Sliders (2 columnas en desktop) -->
                        <div class="lg:col-span-2">
                            <div class="grid md:grid-cols-2 gap-4" id="sliders-container">
                                <!-- Se llenar√°n con JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Contador lateral -->
                        <div class="lg:col-span-1">
                            <div class="sticky top-4 bg-gradient-to-br from-purple-100 to-yellow-100 rounded-lg p-6 text-center">
                                <h3 class="text-lg font-bold text-purple-900 mb-4">Presupuesto por distribuir</h3>
                                <div id="contador" class="text-4xl font-bold text-yellow-600 mb-2">
                                    $195,000
                                </div>
                                <div class="text-lg text-gray-700 mb-4">
                                    millones de pesos
                                </div>
                                <div id="estado-texto" class="text-sm text-gray-600 mb-4">
                                    Distribuye el presupuesto completo
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                                    <div id="barra-progreso" class="bg-gradient-to-r from-purple-600 to-yellow-500 h-4 rounded-full transition-all duration-300" 
                                         style="width: 0%"></div>
                                </div>
                                <div id="mensaje-completado" class="hidden">
                                    <div class="text-green-600 font-bold text-lg mb-3">
                                        ‚úì ¬°Presupuesto redistribuido!
                                    </div>
                                    <button onclick="scrollToGrafico()" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg">
                                        Ver mi propuesta ciudadana ‚Üì
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico (oculto inicialmente) -->
                <div id="grafico-container" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
                    <h3 class="text-2xl font-bold text-purple-900 mb-2 text-center">Si yo fuera Alcalde, NO gastar√≠a en caprichos. Invertir√≠a 195 mil millones en:</h3>
                    <p class="text-gray-600 text-center mb-6">Mi propuesta responde a las necesidades que vivo</p>
                    <div id="barras-container" class="space-y-3 max-w-4xl mx-auto">
                        <!-- Se llenar√°n con JavaScript -->
                    </div>
                    
                    <div class="mt-8 flex justify-center">
                        <button onclick="generarImagen()" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            üì∏ Generar imagen para compartir
                        </button>
                    </div>
                </div>

                <!-- Canvas oculto -->
                <canvas id="canvas" style="display: none;"></canvas>

                <!-- Preview y compartir (oculto inicialmente) -->
                <div id="compartir-container" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
                    <h3 class="text-2xl font-bold text-purple-900 mb-4 text-center">Comparte tu propuesta</h3>
                    <div class="mb-6">
                        <img id="imagen-preview" alt="Mi propuesta" class="w-full max-w-2xl mx-auto rounded-lg shadow-lg" />
                    </div>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button onclick="descargarImagen()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg">
                            ‚¨áÔ∏è Descargar
                        </button>
                        <button onclick="compartirEnRedes('twitter')" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg">
                            üê¶ X 
                        </button>
                        <button onclick="compartirEnRedes('facebook')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                            üìò Facebook
                        </button>
                        <button onclick="compartirEnRedes('whatsapp')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">
                            üí¨ WhatsApp
                        </button>
                    </div>
                </div>

                <!-- Formulario de contacto e ideas -->
                <div id="formulario-container" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
                    <h3 class="text-2xl font-bold text-purple-900 mb-2 text-center">Tu voz importa</h3>
                    <p class="text-gray-600 text-center mb-6">√önete a la Medell√≠n que tiene clara sus prioridades</p>
                    
                    <form id="formulario-contacto" class="max-w-2xl mx-auto">
                        <!-- Datos personales opcionales -->
                        <div class="bg-purple-50 rounded-lg p-6 mb-6">
                            <h4 class="font-bold text-purple-900 mb-4">Datos de contacto (opcional)</h4>
                            <p class="text-sm text-gray-600 mb-4">Si deseas recibir actualizaciones sobre esta iniciativa de control pol√≠tico</p>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                    <input type="text" id="nombre" name="nombre" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                           placeholder="Tu nombre (opcional)">
                                </div>
                                
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo electr√≥nico</label>
                                    <input type="email" id="email" name="email" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                           placeholder="tu@email.com (opcional)">
                                </div>
                                
                                <div>
                                    <label for="whatsapp" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp</label>
                                    <input type="tel" id="whatsapp" name="whatsapp" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                           placeholder="300 123 4567 (opcional)">
                                </div>
                                
                                <div class="flex items-center">
                                    <input type="checkbox" id="autorizo" name="autorizo" class="mr-2">
                                    <label for="autorizo" class="text-sm text-gray-700">
                                        Autorizo el uso de mis datos para esta iniciativa
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campo de ideas -->
                        <div class="bg-yellow-50 rounded-lg p-6 mb-6">
                            <h4 class="font-bold text-purple-900 mb-4">Comparte tus ideas</h4>
                            <p class="text-sm text-gray-600 mb-4">¬øQu√© otras propuestas tienes para mejorar Medell√≠n? (m√°ximo 200 palabras)</p>
                            
                            <textarea id="ideas" name="ideas" rows="5" maxlength="1000"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                      placeholder="Cu√©ntanos tus ideas para un mejor uso de los recursos p√∫blicos..."></textarea>
                            <div class="text-right text-sm text-gray-500 mt-1">
                                <span id="contador-caracteres">0</span>/1000 caracteres
                            </div>
                        </div>
                        
                        <!-- Bot√≥n de env√≠o -->
                        <div class="text-center">
                            <button type="submit" id="btn-enviar" 
                                    class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-8 rounded-lg transition-colors">
                                Enviar mi propuesta ciudadana
                            </button>
                            <div id="mensaje-enviando" class="hidden mt-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-sm text-gray-600 mt-2">Enviando...</p>
                            </div>
                            <div id="mensaje-exito" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                                ‚úì ¬°Gracias por participar! Tu voz ha sido registrada.
                            </div>
                            <div id="mensaje-error" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                                ‚úó Hubo un error. Por favor intenta de nuevo.
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer -->
                <footer class="text-center py-8 text-gray-600">
                    <p class="mb-2">Medell√≠n reflexiona sobre sus necesidades</p>
                    <p class="text-xs mt-4">¬øQu√© es lo √∫nico que le hace falta a Medell√≠n?
Por m√°s derechos y menos caprichos; control pol√≠tico ciudadano.</p>
                </footer>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const PRESUPUESTO_TOTAL = 195000; // En millones
        // Usar proxy de Netlify (IMPORTANTE: no usar la URL directa de Google)
        const BACKEND_URL = '/.netlify/functions/googleProxy';
        
        let imageUrl = '';
        let compartidoEnRedes = false;
        let redCompartida = '';
        let formularioCompletado = false;
        const tiempoInicio = Date.now();
        
        const categorias = [
            { id: 'salud', nombre: 'Salud', emoji: 'üè•', color: '#FF6B6B' },
            { id: 'educacion', nombre: 'Educaci√≥n', emoji: 'üìö', color: '#4ECDC4' },
            { id: 'seguridad', nombre: 'Seguridad', emoji: 'üëÆ', color: '#45B7D1' },
            { id: 'vivienda', nombre: 'Vivienda', emoji: 'üè†', color: '#96CEB4' },
            { id: 'movilidad', nombre: 'Movilidad', emoji: 'üöå', color: '#FFEAA7' },
            { id: 'servicios', nombre: 'Servicios P√∫blicos', emoji: 'üö∞', color: '#DDA0DD' },
            { id: 'deporte', nombre: 'Deporte y Recreaci√≥n', emoji: '‚öΩ', color: '#98D8C8' },
            { id: 'cultura', nombre: 'Cultura', emoji: 'üé≠', color: '#F7DC6F' }
        ];

        // Estado de distribuci√≥n
        let distribucion = {};
        categorias.forEach(cat => {
            distribucion[cat.id] = 0;
        });

        // Formatear n√∫meros
        function formatearMiles(valor) {
            return new Intl.NumberFormat('es-CO').format(valor);
        }

        // Scroll suave al gr√°fico
        function scrollToGrafico() {
            document.getElementById('grafico-container').scrollIntoView({ behavior: 'smooth' });
        }

        // Actualizar contador
        function actualizarContador() {
            const totalAsignado = Object.values(distribucion).reduce((sum, val) => sum + val, 0);
            const restante = PRESUPUESTO_TOTAL - totalAsignado;
            const porcentajeAsignado = (totalAsignado / PRESUPUESTO_TOTAL) * 100;
            
            const contador = document.getElementById('contador');
            const estadoTexto = document.getElementById('estado-texto');
            const barraProgreso = document.getElementById('barra-progreso');
            const mensajeCompletado = document.getElementById('mensaje-completado');
            const graficoContainer = document.getElementById('grafico-container');
            const formularioContainer = document.getElementById('formulario-container');
            
            contador.textContent = `$${formatearMiles(Math.abs(restante))}`;
            barraProgreso.style.width = `${porcentajeAsignado}%`;
            
            if (restante === 0) {
                contador.className = 'text-4xl font-bold text-green-600 mb-2';
                estadoTexto.textContent = '¬°Distribuci√≥n completa!';
                estadoTexto.className = 'text-sm text-green-600 mb-4 font-bold';
                mensajeCompletado.classList.remove('hidden');
                graficoContainer.classList.remove('hidden');
                formularioContainer.classList.remove('hidden');
                actualizarGrafico();
                // Enviar datos autom√°ticamente cuando completan la distribuci√≥n
                enviarDatosAGoogleSheets();
            } else if (restante > 0) {
                contador.className = 'text-4xl font-bold text-yellow-600 mb-2';
                estadoTexto.textContent = `Faltan ${formatearMiles(restante)} millones por asignar`;
                estadoTexto.className = 'text-sm text-gray-600 mb-4';
                mensajeCompletado.classList.add('hidden');
                graficoContainer.classList.add('hidden');
                formularioContainer.classList.add('hidden');
            } else {
                contador.className = 'text-4xl font-bold text-red-600 mb-2';
                estadoTexto.textContent = `Te excediste por ${formatearMiles(Math.abs(restante))} millones`;
                estadoTexto.className = 'text-sm text-red-600 mb-4';
                mensajeCompletado.classList.add('hidden');
                graficoContainer.classList.add('hidden');
                formularioContainer.classList.add('hidden');
            }
        }

        // Manejar cambio de slider
        function handleSliderChange(categoria, valor) {
            const nuevoValor = parseInt(valor);
            const otrosValores = Object.entries(distribucion)
                .filter(([cat]) => cat !== categoria)
                .reduce((sum, [, val]) => sum + val, 0);
            
            if (otrosValores + nuevoValor <= PRESUPUESTO_TOTAL) {
                distribucion[categoria] = nuevoValor;
                
                // Actualizar valor mostrado
                document.getElementById(`valor-${categoria}`).textContent = `$${formatearMiles(nuevoValor)}M`;
                document.getElementById(`porcentaje-${categoria}`).textContent = 
                    `${((nuevoValor / PRESUPUESTO_TOTAL) * 100).toFixed(1)}%`;
                
                // Actualizar color del slider
                const slider = document.getElementById(`slider-${categoria}`);
                const porcentaje = (nuevoValor / PRESUPUESTO_TOTAL) * 100;
                const cat = categorias.find(c => c.id === categoria);
                slider.style.background = `linear-gradient(to right, ${cat.color} 0%, ${cat.color} ${porcentaje}%, #e5e7eb ${porcentaje}%, #e5e7eb 100%)`;
                
                actualizarContador();
            } else {
                // Revertir el slider si excede el presupuesto
                document.getElementById(`slider-${categoria}`).value = distribucion[categoria];
            }
        }

        // Actualizar gr√°fico de barras
        function actualizarGrafico() {
            const container = document.getElementById('barras-container');
            container.innerHTML = '';
            
            // Ordenar categor√≠as por valor de mayor a menor
            const categoriasOrdenadas = [...categorias].sort((a, b) => 
                distribucion[b.id] - distribucion[a.id]
            ).filter(cat => distribucion[cat.id] > 0);
            
            categoriasOrdenadas.forEach(cat => {
                const valor = distribucion[cat.id];
                const porcentaje = (valor / PRESUPUESTO_TOTAL) * 100;
                
                const barra = document.createElement('div');
                barra.className = 'flex items-center gap-3';
                barra.innerHTML = `
                    <div class="w-36 text-right flex items-center justify-end gap-2">
                        <span class="text-2xl">${cat.emoji}</span>
                        <span class="text-sm font-semibold">${cat.nombre}</span>
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-200 rounded-full h-10 relative overflow-hidden">
                            <div class="h-10 rounded-full flex items-center justify-end pr-3 transition-all duration-500" 
                                 style="width: ${porcentaje}%; background-color: ${cat.color}">
                                <span class="text-sm font-bold text-white">${porcentaje.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-28 text-right font-bold text-purple-900">
                        $${formatearMiles(valor)}M
                    </div>
                `;
                container.appendChild(barra);
            });
        }

        // Generar imagen
        function generarImagen() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1200;
            canvas.height = 630;
            
            // Fondo blanco
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, 1200, 630);
            
            // Header morado
            ctx.fillStyle = '#7010A6';
            ctx.fillRect(0, 0, 1200, 120);
            
            // T√≠tulo
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Si yo fuera Alcalde invertir√≠a 195 mil millones en:', 600, 70);
            
            // Subt√≠tulo
            ctx.fillStyle = '#FCD700';
            ctx.font = '20px Arial';
            ctx.fillText('Esta es mi propuesta de distribuci√≥n presupuestal', 600, 100);
            
            // Dibujar barras
            const startY = 150;
            const barHeight = 45;
            const maxBarWidth = 650;
            const startX = 280;
            
            // Ordenar y filtrar categor√≠as
            const categoriasOrdenadas = [...categorias]
                .sort((a, b) => distribucion[b.id] - distribucion[a.id])
                .filter(cat => distribucion[cat.id] > 0);
            
            categoriasOrdenadas.forEach((cat, index) => {
                const y = startY + (index * (barHeight + 8));
                const valor = distribucion[cat.id];
                const porcentaje = (valor / PRESUPUESTO_TOTAL) * 100;
                const barWidth = (porcentaje / 100) * maxBarWidth;
                
                // Emoji y nombre
                ctx.font = '20px Arial';
                ctx.fillStyle = '#333333';
                ctx.textAlign = 'right';
                ctx.fillText(`${cat.emoji} ${cat.nombre}`, startX - 15, y + 28);
                
                // Fondo de la barra
                ctx.fillStyle = '#E5E7EB';
                ctx.fillRect(startX, y, maxBarWidth, barHeight);
                
                // Barra de progreso
                ctx.fillStyle = cat.color;
                ctx.fillRect(startX, y, barWidth, barHeight);
                
                // Porcentaje dentro de la barra
                if (porcentaje > 5) {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${porcentaje.toFixed(1)}%`, startX + barWidth/2, y + 28);
                }
                
                // Valor
                ctx.fillStyle = '#333333';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${formatearMiles(valor)}M`, startX + maxBarWidth + 15, y + 28);
            });
            
            // Footer con nuevo texto
            ctx.fillStyle = '#7010A6';
            ctx.font = 'bold 22px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Para m√≠, mientras hayan 313.257 personas en pobreza,', 600, 540);
            ctx.fillText('las piscinas NO son una prioridad ni hacen que a Medell√≠n no le falte nada', 600, 570);
            
            ctx.fillStyle = '#FCD700';
            ctx.font = 'bold 18px Arial';
            ctx.fillText('#Medell√≠nDecide #PresupuestoParticipativo', 600, 600);
            
            imageUrl = canvas.toDataURL('image/png');
            document.getElementById('imagen-preview').src = imageUrl;
            document.getElementById('compartir-container').classList.remove('hidden');
            document.getElementById('compartir-container').scrollIntoView({ behavior: 'smooth' });
        }

        // Descargar imagen
        function descargarImagen() {
            const link = document.createElement('a');
            link.download = 'mi-presupuesto-medellin.png';
            link.href = imageUrl;
            link.click();
        }

        // Compartir en redes
        function compartirEnRedes(red) {
            const mensaje = encodeURIComponent('El Alcalde gastar√° 195 mil millones en piscinas mientras 313,257 personas viven en pobreza. Yo invertir√≠a diferente. ¬øY t√∫? Haz tu propuesta ciudadana #Medell√≠nDecide #NoM√°sCaprichos');
            const url = encodeURIComponent(window.location.href);
            
            const urls = {
                twitter: `https://twitter.com/intent/tweet?text=${mensaje}&url=${url}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${url}`,
                whatsapp: `https://wa.me/?text=${mensaje}%20${url}`
            };
            
            window.open(urls[red], '_blank');
            
            // Registrar que comparti√≥
            compartidoEnRedes = true;
            redCompartida = red;
            enviarDatosAGoogleSheets();
        }

        // Funci√≥n auxiliar para detectar navegador
        function detectarNavegador() {
            const agent = navigator.userAgent;
            if (agent.indexOf('Chrome') > -1) return 'Chrome';
            if (agent.indexOf('Safari') > -1) return 'Safari';
            if (agent.indexOf('Firefox') > -1) return 'Firefox';
            return 'Otro';
        }

        // Funci√≥n para enviar datos a Google Sheets
        async function enviarDatosAGoogleSheets() {
            // Recopilar todos los datos
            const datosParaEnviar = {
                action: 'guardar_respuesta',
                timestamp: new Date().toISOString(),
                session_id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                
                // Distribuci√≥n
                distribucion: distribucion,
                
                // Comportamiento
                imagen_generada: imageUrl ? 'SI' : 'NO',
                imagen_compartida: compartidoEnRedes ? 'SI' : 'NO',
                red_compartida: redCompartida || '',
                formulario_completado: formularioCompletado ? 'SI' : 'NO',
                
                // Datos opcionales (si los dieron)
                nombre: document.getElementById('nombre')?.value || '',
                email: document.getElementById('email')?.value || '',
                whatsapp: document.getElementById('whatsapp')?.value || '',
                autorizo_contacto: document.getElementById('autorizo')?.checked ? 'SI' : 'NO',
                ideas: document.getElementById('ideas')?.value || '',
                
                // Datos t√©cnicos
                dispositivo: screen.width < 768 ? 'M√≥vil' : 'Desktop',
                navegador: detectarNavegador(),
                tiempo_sesion_segundos: Math.floor((Date.now() - tiempoInicio) / 1000)
            };
            
            try {
                console.log('Enviando datos al backend...');
                
                // Intentar primero con el proxy de Netlify
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datosParaEnviar)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos enviados exitosamente:', data);
                    
                    // Mostrar n√∫mero de participante si est√° disponible
                    if (data.estadisticas && data.estadisticas.total_participantes) {
                        console.log(`Eres el participante #${data.estadisticas.total_participantes}`);
                    }
                } else {
                    console.error('Error del proxy:', response.status);
                    // Guardar localmente como backup
                    localStorage.setItem('respuesta_backup_' + Date.now(), JSON.stringify(datosParaEnviar));
                    console.log('Datos guardados localmente como backup');
                }
                
            } catch (error) {
                console.error('Error enviando datos:', error);
                // Guardar localmente como backup
                localStorage.setItem('respuesta_backup_' + Date.now(), JSON.stringify(datosParaEnviar));
                console.log('Datos guardados localmente como backup');
            }
        }

        // Inicializar sliders
        function inicializarSliders() {
            const container = document.getElementById('sliders-container');
            
            categorias.forEach(cat => {
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'bg-gray-50 p-4 rounded-lg';
                sliderDiv.innerHTML = `
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <label class="flex items-center gap-2 font-semibold text-gray-700">
                                <span class="text-2xl">${cat.emoji}</span>
                                <span class="text-sm">${cat.nombre}</span>
                                <div class="text-sm text-gray-500 mt-1">
                                    Ajusta en incrementos de mil millones
                                </div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span id="porcentaje-${cat.id}" class="text-gray-600">0%</span>
                            <span id="valor-${cat.id}" class="font-bold text-purple-900">$0M</span>
                        </div>
                        <input
                            type="range"
                            id="slider-${cat.id}"
                            min="0"
                            max="${PRESUPUESTO_TOTAL}"
                            step="1000"
                            value="0"
                            onchange="handleSliderChange('${cat.id}', this.value)"
                            oninput="handleSliderChange('${cat.id}', this.value)"
                            class="slider w-full"
                            style="background: linear-gradient(to right, ${cat.color} 0%, ${cat.color} 0%, #e5e7eb 0%, #e5e7eb 100%)"
                        />
                    </div>
                `;
                container.appendChild(sliderDiv);
            });
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            inicializarSliders();
            actualizarContador();
            
            // Contador de caracteres para el campo de ideas
            const ideasTextarea = document.getElementById('ideas');
            const contadorCaracteres = document.getElementById('contador-caracteres');
            
            if (ideasTextarea && contadorCaracteres) {
                ideasTextarea.addEventListener('input', function() {
                    contadorCaracteres.textContent = this.value.length;
                });
            }
            
            // Manejar env√≠o del formulario
            const formulario = document.getElementById('formulario-contacto');
            if (formulario) {
                formulario.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const btnEnviar = document.getElementById('btn-enviar');
                    const mensajeEnviando = document.getElementById('mensaje-enviando');
                    const mensajeExito = document.getElementById('mensaje-exito');
                    const mensajeError = document.getElementById('mensaje-error');
                    
                    // Mostrar estado de env√≠o
                    btnEnviar.style.display = 'none';
                    mensajeEnviando.classList.remove('hidden');
                    mensajeExito.classList.add('hidden');
                    mensajeError.classList.add('hidden');
                    
                    // Marcar formulario como completado
                    formularioCompletado = true;
                    
                    try {
                        // Enviar datos actualizados
                        await enviarDatosAGoogleSheets();
                        
                        // Mostrar √©xito
                        mensajeEnviando.classList.add('hidden');
                        mensajeExito.classList.remove('hidden');
                        
                        // Resetear formulario despu√©s de 3 segundos
                        setTimeout(() => {
                            formulario.reset();
                            btnEnviar.style.display = 'inline-block';
                            mensajeExito.classList.add('hidden');
                            contadorCaracteres.textContent = '0';
                        }, 3000);
                        
                    } catch (error) {
                        console.error('Error:', error);
                        mensajeEnviando.classList.add('hidden');
                        mensajeError.classList.remove('hidden');
                        btnEnviar.style.display = 'inline-block';
                        
                        setTimeout(() => {
                            mensajeError.classList.add('hidden');
                        }, 5000);
                    }
                });
            }
        });
    </script>
</body>
</html>
