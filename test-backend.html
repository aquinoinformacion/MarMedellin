<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Directo API Google Apps Script</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">Test Directo de Google Apps Script</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <label class="block mb-2 font-semibold">URL del Google Apps Script:</label>
            <input type="text" id="scriptUrl" 
                   class="w-full p-2 border rounded mb-4"
                   placeholder="https://script.google.com/macros/s/XXX/exec"
                   value="">
            <p class="text-sm text-gray-600 mb-4">
                Pega aquí la URL que obtuviste al desplegar el Google Apps Script
            </p>
        </div>

        <div class="grid gap-4">
            <!-- Test GET -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-4">1. Test GET (verificar que está activo)</h2>
                <button onclick="testGet()" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Probar GET
                </button>
                <div id="result-get" class="mt-4"></div>
            </div>

            <!-- Test POST Simple -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-4">2. Test POST Simple</h2>
                <button onclick="testPostSimple()" 
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Probar POST Simple
                </button>
                <div id="result-post-simple" class="mt-4"></div>
            </div>

            <!-- Test POST Completo -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-4">3. Test POST con Datos Completos</h2>
                <button onclick="testPostCompleto()" 
                        class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Probar POST Completo
                </button>
                <div id="result-post-completo" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        // Función helper para mostrar resultados
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            const bgColor = isError ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300';
            element.className = `mt-4 p-4 ${bgColor} border rounded`;
            element.innerHTML = `<pre class="text-sm overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
        }

        // Test GET
        async function testGet() {
            const url = document.getElementById('scriptUrl').value;
            if (!url) {
                alert('Por favor ingresa la URL del Google Apps Script');
                return;
            }

            try {
                console.log('Probando GET a:', url);
                const response = await fetch(url);
                const data = await response.text();
                
                try {
                    const jsonData = JSON.parse(data);
                    showResult('result-get', jsonData, !response.ok);
                } catch (e) {
                    showResult('result-get', {
                        status: response.status,
                        response: data.substring(0, 500)
                    }, true);
                }
            } catch (error) {
                showResult('result-get', {
                    error: error.message
                }, true);
            }
        }

        // Test POST Simple
        async function testPostSimple() {
            const url = document.getElementById('scriptUrl').value;
            if (!url) {
                alert('Por favor ingresa la URL del Google Apps Script');
                return;
            }

            const testData = {
                action: 'test',
                message: 'Prueba simple',
                timestamp: new Date().toISOString()
            };

            try {
                console.log('Enviando POST simple:', testData);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.text();
                
                try {
                    const jsonData = JSON.parse(data);
                    showResult('result-post-simple', jsonData, !response.ok);
                } catch (e) {
                    showResult('result-post-simple', {
                        status: response.status,
                        response: data.substring(0, 500)
                    }, true);
                }
            } catch (error) {
                showResult('result-post-simple', {
                    error: error.message
                }, true);
            }
        }

        // Test POST Completo
        async function testPostCompleto() {
            const url = document.getElementById('scriptUrl').value;
            if (!url) {
                alert('Por favor ingresa la URL del Google Apps Script');
                return;
            }

            const testData = {
                action: 'guardar_respuesta',
                timestamp: new Date().toISOString(),
                session_id: 'test_directo_' + Date.now(),
                distribucion: {
                    salud: 60000,
                    educacion: 50000,
                    seguridad: 20000,
                    vivienda: 35000,
                    movilidad: 15000,
                    servicios: 5000,
                    deporte: 5000,
                    cultura: 5000
                },
                imagen_generada: 'SI',
                imagen_compartida: 'NO',
                red_compartida: '',
                formulario_completado: 'NO',
                nombre: 'Test Directo',
                email: 'test@test.com',
                whatsapp: '',
                autorizo_contacto: 'SI',
                ideas: 'Esta es una prueba directa del API',
                dispositivo: 'Test',
                navegador: 'Test Browser',
                tiempo_sesion_segundos: 60
            };

            try {
                console.log('Enviando datos completos:', testData);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.text();
                
                try {
                    const jsonData = JSON.parse(data);
                    showResult('result-post-completo', jsonData, !response.ok);
                    
                    if (jsonData.success) {
                        alert('¡Éxito! Revisa tu Google Sheet para ver los datos guardados.');
                    }
                } catch (e) {
                    showResult('result-post-completo', {
                        status: response.status,
                        response: data.substring(0, 500)
                    }, true);
                }
            } catch (error) {
                showResult('result-post-completo', {
                    error: error.message
                }, true);
            }
        }

        // Auto-llenar si hay una URL en localStorage
        const savedUrl = localStorage.getItem('googleScriptUrl');
        if (savedUrl) {
            document.getElementById('scriptUrl').value = savedUrl;
        }

        // Guardar URL cuando cambie
        document.getElementById('scriptUrl').addEventListener('change', (e) => {
            localStorage.setItem('googleScriptUrl', e.target.value);
        });
    </script>
</body>
</html>
