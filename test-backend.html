<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Backend - Presupuesto Participativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-purple-900">Test de Backend - Presupuesto Participativo</h1>
        
        <!-- Test 1: Conexión directa a Google Apps Script -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 text-purple-700">Test 1: Conexión Directa a Google Apps Script</h2>
            <p class="text-gray-600 mb-4">Intenta enviar datos directamente al endpoint de Google (probablemente fallará con 401)</p>
            <button onclick="testDirectGoogle()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                Probar Conexión Directa
            </button>
            <div id="result-direct" class="mt-4 p-4 bg-gray-50 rounded hidden"></div>
        </div>

        <!-- Test 2: Conexión a través de Netlify Proxy -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 text-purple-700">Test 2: Conexión via Netlify Proxy</h2>
            <p class="text-gray-600 mb-4">Envía datos a través de la función proxy de Netlify (debería funcionar)</p>
            <button onclick="testNetlifyProxy()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Probar via Proxy
            </button>
            <div id="result-proxy" class="mt-4 p-4 bg-gray-50 rounded hidden"></div>
        </div>

        <!-- Test 3: Enviar datos de prueba completos -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 text-purple-700">Test 3: Enviar Datos de Prueba Completos</h2>
            <p class="text-gray-600 mb-4">Simula el envío de una distribución presupuestaria completa</p>
            <button onclick="testEnvioCompleto()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Enviar Distribución de Prueba
            </button>
            <div id="result-completo" class="mt-4 p-4 bg-gray-50 rounded hidden"></div>
        </div>

        <!-- Test 4: Obtener estadísticas -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 text-purple-700">Test 4: Obtener Estadísticas</h2>
            <p class="text-gray-600 mb-4">Intenta obtener las estadísticas actuales del sistema</p>
            <button onclick="testObtenerEstadisticas()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                Obtener Estadísticas
            </button>
            <div id="result-stats" class="mt-4 p-4 bg-gray-50 rounded hidden"></div>
        </div>
    </div>

    <script>
        // URLs de los endpoints
        const GOOGLE_DIRECT_URL = 'https://script.google.com/macros/s/AKfycbxGGJhHOxQjjSug5mLu1Pkr7dNHsoKRrjfCGIo8gpgqRRvrW7wzbZaDeupKij9MEUPh/exec';
        const NETLIFY_PROXY_URL = '/.netlify/functions/googleProxy';
        // Alternativa usando la redirección del netlify.toml
        const API_URL = '/api/googleProxy';

        // Función helper para mostrar resultados
        function showResult(elementId, success, data) {
            const element = document.getElementById(elementId);
            element.classList.remove('hidden');
            
            if (success) {
                element.className = 'mt-4 p-4 bg-green-50 border border-green-300 rounded';
                element.innerHTML = `
                    <strong class="text-green-700">✓ Éxito!</strong>
                    <pre class="mt-2 text-sm overflow-auto">${JSON.stringify(data, null, 2)}</pre>
                `;
            } else {
                element.className = 'mt-4 p-4 bg-red-50 border border-red-300 rounded';
                element.innerHTML = `
                    <strong class="text-red-700">✗ Error:</strong>
                    <pre class="mt-2 text-sm overflow-auto">${JSON.stringify(data, null, 2)}</pre>
                `;
            }
        }

        // Test 1: Conexión directa
        async function testDirectGoogle() {
            console.log('Probando conexión directa a Google Apps Script...');
            
            const testData = {
                action: 'guardar_respuesta',
                timestamp: new Date().toISOString(),
                session_id: 'test_' + Date.now(),
                distribucion: {
                    salud: 50000,
                    educacion: 45000,
                    seguridad: 30000,
                    vivienda: 40000,
                    movilidad: 30000,
                    servicios: 0,
                    deporte: 0,
                    cultura: 0
                },
                imagen_generada: 'NO',
                imagen_compartida: 'NO',
                red_compartida: '',
                formulario_completado: 'NO',
                nombre: 'Test Directo',
                email: '',
                whatsapp: '',
                autorizo_contacto: 'NO',
                ideas: '',
                dispositivo: 'Test',
                navegador: 'Test',
                tiempo_sesion_segundos: 0
            };

            try {
                const response = await fetch(GOOGLE_DIRECT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Esto evita el error CORS pero no podemos leer la respuesta
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                // Con no-cors no podemos leer la respuesta
                showResult('result-direct', false, {
                    message: 'Petición enviada pero no se puede leer la respuesta debido a CORS',
                    nota: 'Esto es normal. Por eso necesitamos el proxy.'
                });
            } catch (error) {
                showResult('result-direct', false, {
                    error: error.message,
                    tipo: 'Error de red o CORS'
                });
            }
        }

        // Test 2: Via Netlify Proxy
        async function testNetlifyProxy() {
            console.log('Probando conexión via Netlify Proxy...');
            
            const testData = {
                action: 'guardar_respuesta',
                timestamp: new Date().toISOString(),
                session_id: 'test_proxy_' + Date.now(),
                distribucion: {
                    salud: 50000,
                    educacion: 45000,
                    seguridad: 30000,
                    vivienda: 40000,
                    movilidad: 30000,
                    servicios: 0,
                    deporte: 0,
                    cultura: 0
                },
                imagen_generada: 'NO',
                imagen_compartida: 'NO',
                red_compartida: '',
                formulario_completado: 'NO',
                nombre: 'Test Proxy',
                email: '',
                whatsapp: '',
                autorizo_contacto: 'NO',
                ideas: '',
                dispositivo: 'Test',
                navegador: 'Test',
                tiempo_sesion_segundos: 0
            };

            try {
                const response = await fetch(NETLIFY_PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const data = await response.json();
                showResult('result-proxy', response.ok, data);
            } catch (error) {
                showResult('result-proxy', false, {
                    error: error.message,
                    nota: 'Asegúrate de que la función de Netlify esté desplegada'
                });
            }
        }

        // Test 3: Envío completo
        async function testEnvioCompleto() {
            console.log('Enviando distribución completa de prueba...');
            
            const testData = {
                action: 'guardar_respuesta',
                timestamp: new Date().toISOString(),
                session_id: 'test_completo_' + Date.now(),
                distribucion: {
                    salud: 60000,
                    educacion: 50000,
                    seguridad: 20000,
                    vivienda: 35000,
                    movilidad: 15000,
                    servicios: 5000,
                    deporte: 5000,
                    cultura: 5000
                },
                imagen_generada: 'SI',
                imagen_compartida: 'SI',
                red_compartida: 'whatsapp',
                formulario_completado: 'SI',
                nombre: 'Juan Pérez',
                email: 'juan@test.com',
                whatsapp: '3001234567',
                autorizo_contacto: 'SI',
                ideas: 'Creo que deberíamos invertir más en educación y salud, son las bases para el desarrollo.',
                dispositivo: 'Desktop',
                navegador: 'Chrome',
                tiempo_sesion_segundos: 180
            };

            try {
                const response = await fetch(NETLIFY_PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const data = await response.json();
                showResult('result-completo', response.ok, data);
            } catch (error) {
                showResult('result-completo', false, {
                    error: error.message
                });
            }
        }

        // Test 4: Obtener estadísticas
        async function testObtenerEstadisticas() {
            console.log('Obteniendo estadísticas...');
            
            const requestData = {
                action: 'obtener_estadisticas'
            };

            try {
                const response = await fetch(NETLIFY_PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                showResult('result-stats', response.ok, data);
            } catch (error) {
                showResult('result-stats', false, {
                    error: error.message
                });
            }
        }

        // Log para debugging
        console.log('Página de prueba cargada. URLs configuradas:');
        console.log('- Google Direct:', GOOGLE_DIRECT_URL);
        console.log('- Netlify Proxy:', NETLIFY_PROXY_URL);
    </script>
</body>
</html>
